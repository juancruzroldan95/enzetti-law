---
import { Image } from "astro:assets";
import logo from "../assets/logo.webp";
import WhatsApp from "../icons/WhatsApp.astro";
import IconX from "../icons/IconX.astro";

const { pathname } = Astro.url;

const navItems = [
  { name: "Servicios", href: "#servicios" },
  { name: "Equipo", href: "#equipo" },
  { name: "Redes", href: "#redes" },
  { name: "Proceso", href: "#proceso" },
  { name: "Reseñas", href: "#resenas" },
  { name: "Nosotros", href: "/nosotros" },
];
---

<div
  id="mobile-menu"
  class="fixed inset-0 z-[999] invisible pointer-events-none md:hidden"
>
  {/* Backdrop blur/darken */}
  <div
    id="mobile-menu-backdrop"
    class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-500"
  >
  </div>

  {/* Menu Content */}
  <div
    class="absolute right-0 top-0 h-full w-[85%] max-w-sm bg-white shadow-2xl flex flex-col p-8 transform translate-x-full transition-transform duration-500 ease-out border-l border-gray-100"
    id="mobile-menu-panel"
  >
    {/* Decorative gradient strip */}
    <div
      class="absolute left-0 top-0 bottom-0 w-1 bg-gradient-to-b from-accent via-accent-dark to-primary"
    >
    </div>

    <div class="flex justify-between items-center mb-12">
      <a href="/" id="mobile-menu-logo">
        <Image
          src={logo}
          alt="Estudio Enzetti"
          class="h-16 w-auto"
          quality="max"
        />
      </a>
      <button
        id="close-menu"
        class="p-2 text-primary hover:text-accent transition-all duration-300 transform hover:rotate-90 cursor-pointer"
        aria-label="Cerrar menú"
      >
        <IconX />
      </button>
    </div>

    <nav class="flex flex-col space-y-7">
      {
        navItems.map((item, index) => {
          const href =
            item.href.startsWith("#") && pathname !== "/"
              ? `/${item.href}`
              : item.href;
          return (
            <a
              href={href}
              class="text-xl font-bold text-primary hover:text-accent transition-all duration-300 mobile-nav-item flex items-center justify-between group opacity-0 -translate-x-8"
              style={`transition-delay: ${index * 80 + 100}ms`}
            >
              {item.name}
              <span class="w-2 h-2 rounded-full bg-accent opacity-0 group-hover:opacity-100 transition-opacity" />
            </a>
          );
        })
      }
    </nav>

    <div class="mt-auto pt-8 border-t border-gray-100 italic">
      <a
        href="https://wa.me/5491143711602"
        target="_blank"
        rel="noopener noreferrer"
        class="block"
      >
        <button
          class="w-full bg-green-500 hover:bg-green-400 text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 shadow-lg shadow-[#25D366]/20 transition-all duration-300"
        >
          <WhatsApp class="w-6 h-6" />
          Consulta Gratuita
        </button>
      </a>
    </div>
  </div>
</div>

<script>
  function initMobileMenu() {
    const menu = document.getElementById("mobile-menu");
    const openBtn = document.getElementById("open-menu");
    const closeBtn = document.getElementById("close-menu");
    const backdrop = document.getElementById("mobile-menu-backdrop");
    const panel = document.getElementById("mobile-menu-panel");
    const navLinks = document.querySelectorAll(".mobile-nav-item");
    const logoLink = document.getElementById("mobile-menu-logo");

    function openMenu() {
      menu?.classList.remove("invisible", "pointer-events-none");
      // Small delay to ensure display:none -> block transition works
      setTimeout(() => {
        backdrop?.classList.remove("opacity-0");
        panel?.classList.remove("translate-x-full");
        navLinks.forEach((link) => {
          link.classList.remove("opacity-0", "-translate-x-8");
        });
      }, 10);
      document.body.classList.add("overflow-hidden");
    }

    function closeMenu() {
      backdrop?.classList.add("opacity-0");
      panel?.classList.add("translate-x-full");
      navLinks.forEach((link) => {
        link.classList.add("opacity-0", "-translate-x-8");
      });
      document.body.classList.remove("overflow-hidden");

      // Wait for transition to finish
      setTimeout(() => {
        menu?.classList.add("invisible", "pointer-events-none");
      }, 500);
    }

    openBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      openMenu();
    });

    closeBtn?.addEventListener("click", closeMenu);
    backdrop?.addEventListener("click", closeMenu);
    logoLink?.addEventListener("click", closeMenu);

    navLinks.forEach((link) => {
      link.addEventListener("click", closeMenu);
    });
  }

  // Initialize on first load
  initMobileMenu();

  // Re-initialize after view transitions
  document.addEventListener("astro:after-swap", initMobileMenu);
</script>
